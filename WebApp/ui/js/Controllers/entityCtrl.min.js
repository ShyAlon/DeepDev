angular.module("DeepDev.controllers").controller("entityCtrl",["$scope","$rootScope","$http","$window","$location","$animate","$timeout","$routeParams","server","local","authentication","ui",function(n,t,i,r,u,f,e,o,s,h,c,l){n.$on("$viewContentLoaded",function(){c.initialize(y);n.subitem="Requirement";t.hide=!1;t.loading=!0});var y=function(){t.wizardItem=null;s.getEntity({id:o.entityId.replace(":","")},v,p,o.entity.replace(":",""))},v=function(i){if(t.loading=!1,t.clearWatch)for(var r=0;r<t.clearWatch.length;r++)t.clearWatch[r]();t.clearWatch=[];h.initialize(i,n,v);n.showEffort=t.wizardItem.hasOwnProperty("Effort");n.showEffortEstimation=t.wizardItem.hasOwnProperty("EffortEstimation");n.showInitiator=t.wizardItem.hasOwnProperty("Initiator");t.wizardItem.requirements=[];i.Effort&&(t.wizardItem.Effort=i.Effort);w();n.save=function(){n.wizardDone()};t.data.Type=="UseCase"?(t.data.size=0,t.data.hide=!1,k(t.data)):t.data.Type=="Task"?g():t.data.Type=="Project"?b():t.data.Type=="Component"&&d()},p=function(n){t.loading=!1;console.log("Failed to get projects for user in  "+u.path());console.log(n)},w=function(){l.configureDatetimepicker(n);l.configureWizard(n,["General","Predecessors","Summary"])},nt=function(){};n.createTask=function(){h.saveEntityAndCreate("Task","Milestone","taskEdit")};var b=function(){var f,i;for(n.usersTypes=[{id:1,name:"ProductManager",users:[]},{id:2,name:"ProjectManager",users:[]},{id:4,name:"SystemEngineer",users:[]}],t.projectUserEmail=t.userEmail,f=0;f<t.data.Users.length;f++)i=t.data.Users[f],i.UserType&1&&n.usersTypes[0].users.push(i),i.UserType&2&&n.usersTypes[1].users.push(i),i.UserType&4&&n.usersTypes[2].users.push(i);t.userType=n.usersTypes[0];n.addUser=function(){for(var i=0;i<t.userType.users.length;i++)if(t.userType.users[i].UserMail==t.projectUserEmail){console.log(t.userType.users[i].UserMail+" is already a "+t.userType.name);return}t.userType.users.push({Id:-1,UserMail:t.projectUserEmail,ProjectId:t.wizardItem.Id,UserType:n.userType.id,Name:"A",Description:"A"})};n.removeUser=function(n,t){index=-1;for(var i=0;i<t.users.length;i++)if(t.users[i].UserMail===n.UserMail){index=i;break}index>-1&&t.users.splice(index,1)};n.exportProject=function(){var n=function(n){console.log(n);r.open("/Server/api/FileGet?fileId="+n)},i=function(n){console.log("Failed to get location for user in  "+u.path());console.log(n)};s.getEntity({id:t.wizardItem.Id},n,i,"Export")};var o=function(){console.log("deleted Project User")},h=function(){console.log("Created Project User")},c=function(){console.log("Updated Project User")},e=function(){console.log("failed to something project user")};n.saveUsers=function(){for(var i,r,l,a={},f={},v={},y={},u=0;u<t.data.Users.length;u++)y[t.data.Users[u].UserMail]=t.data.Users[u];for(i=0;i<n.usersTypes.length;i++)for(r=0;r<n.usersTypes[i].users.length;r++)y[n.usersTypes[i].users[r].UserMail]!=undefined?f[n.usersTypes[i].users[r].UserMail]!=undefined?f[n.usersTypes[i].users[r].UserMail].UserType|=n.usersTypes[i].users[r].UserType:f[n.usersTypes[i].users[r].UserMail]=n.usersTypes[i].users[r]:a[n.usersTypes[i].users[r].UserMail]!=undefined?a[n.usersTypes[i].users[r].UserMail].UserType|=n.usersTypes[i].users[r].UserType:a[n.usersTypes[i].users[r].UserMail]=n.usersTypes[i].users[r];for(u=0;u<t.data.Users.length;u++)f[t.data.Users[u].UserMail]||(v[t.data.Users[u].UserMail]=t.data.Users[u]);for(l in a)s.commitEntity(a[l],h,e,"ProjectUser");for(l in f)s.updateEntity(f[l],c,e,"ProjectUser");for(l in v)s.deleteEntity(v[l],o,e,"ProjectUser")}},k=function(i){var u=function(){if(t.wizardItem){a();t.wizardItem.MethodComments={};for(var n=0;n<t.data.Methods.length;n++)t.data.Methods[n].comment&&(t.wizardItem.MethodComments[t.data.Methods[n].Entity.Id]=t.data.Methods[n].comment)}},f=h.getSequenceStatus(i),r;for(i.Entity.Status=f.text,i.Entity.color=f.color,i.Entity.hideInProj=!0,n.minId=-2,t.clearWatch.push(t.$watch("wizardItem.Initiator",function(){u()})),r=0;r<i.Methods.length;r++)i.Entity.MethodComments[i.Methods[r].Entity.Id]&&(i.Methods[r].comment=i.Entity.MethodComments[i.Methods[r].Entity.Id]),t.data.Methods[r].Entity.Id<n.minId&&(n.minId=t.data.Methods[r].Entity.Id),t.clearWatch.push(t.$watch("data.Methods["+r+"].comment",function(){u()}));n.getScale=function(n){for(var r=n.length/2-4,t=1,i=0;i<r;i++)t=t*.9;return t};a(i);n.module=null;n.component=null;n.method=null;n.components=function(){var u=[],i,r;if(t.moduleName&&t.data&&t.data.Modules)for(i=0;i<t.data.Modules.length;i++)if(t.moduleName==t.data.Modules[i].Entity.Name){if(n.module=t.data.Modules[i],t.data.Modules[i].Children.Components)for(r=0;r<t.data.Modules[i].Children.Components.length;r++)u.push(t.data.Modules[i].Children.Components[r]);else console.log("No components");break}return u};n.methods=function(){var u=[],i,r;if(n.module&&n.module.Children.Components)for(i=0;i<n.module.Children.Components.length;i++)if(t.componentName==n.module.Children.Components[i].Entity.Name&&(n.component=n.module.Children.Components[i],n.module.Children.Components[i].Children.Methods))for(r=0;r<n.module.Children.Components[i].Children.Methods.length;r++)u.push(n.module.Children.Components[i].Children.Methods[r]);return u};n.deleteChild=function(n){for(var u=n.item,r=-1,i=0;i<t.data.Methods.length;i++)if(u.Entity.Id==t.data.Methods[i].Entity.Id){t.data.Methods.splice(i,1);t.wizardItem.MethodIds.splice(i,1);break}r>-1&&t.wizardItem.MethodIds.splice(r,1);a()};n.onAdd=function(i){var u=i.item,f,r;for(console.log(u),f=-1,r=0;r<t.data.Methods.length;r++)if(u.Entity.Id==t.data.Methods[r].Entity.Id){console.log("Inserting return after "+t.data.Methods[r].Entity.Id);n.addReturn(r+1);break}else console.log("Not deleting method "+t.data.Methods[r].Entity.Id)};n.onRemove=function(i){for(var u=i.item,r=0;r<t.data.Methods.length;r++)if(u.Entity.Id==t.data.Methods[r].Entity.Id){console.log("Inserting no return after "+t.data.Methods[r].Entity.Id);n.addNoReturn(r+1);break}else console.log("Not deleting method "+t.data.Methods[r].Entity.Id)};n.onReplace=function(i){for(var f=i.item,u=-1,r=0;r<t.data.Methods.length;r++)if(f.Entity.Id==t.data.Methods[r].Entity.Id){u=r;break}n.insertIndex=u;n.addMethod()};n.addMethod=function(){var i,r;for(n.module=null,i=0;i<t.data.Modules.length;i++)if(t.moduleName==t.data.Modules[i].Entity.Name){n.module=t.data.Modules[i];break}n.module?e(n.module):(r="new module for "+t.data.Parent.Name,t.module={ParentId:t.data.ProjectId,Name:t.moduleName,Description:r,Id:-1},s.commitEntity(t.module,function(n){h.refreshTree(e(n))},null,"Module"))};var e=function(i){var r,u;for(n.module=i,n.component=null,r=0;r<n.module.Children.Components.length;r++)if(t.componentName==n.module.Children.Components[r].Entity.Name){n.component=n.module.Children.Components[r];break}n.component?o(n.component):(u="new component for "+n.module.Entity.Name,t.component={ParentId:n.module.Entity.Id,Name:t.componentName,Description:u,Id:-1},s.commitEntity(t.component,function(n){h.refreshTree(o(n))},null,"component"))},o=function(i){var r,u;for(n.component=i,n.method=null,r=0;r<n.component.Children.Methods.length;r++)if(t.methodName==n.component.Children.Methods[r].Entity.Name){n.method=n.component.Children.Methods[r];break}n.method?c(n.method):(u="new method for "+t.data.Parent.Name,t.method={ParentId:n.component.Entity.Id,Name:t.methodName,Description:u,Id:-1},s.commitEntity(t.method,c,null,"method"))},c=function(i){n.insertIndex||n.insertIndex==0?(t.data.Methods.splice(n.insertIndex,0,i),t.wizardItem.MethodIds.splice(n.insertIndex,0,i.Entity.Id)):(t.data.Methods.push(i),t.wizardItem.MethodIds.push(i.Entity.Id));n.insertIndex=null;t.$watch("data.Methods["+t.data.Methods.length+"].comment",function(){u()});a()};n.addReturn=function(i){n.minId=n.minId%2==-1?n.minId-2:n.minId-1;i?(t.wizardItem.MethodIds.splice(i,0,n.minId),t.data.Methods.splice(i,0,{Entity:{Id:n.minId,Name:"Return"}})):(t.wizardItem.MethodIds.push(n.minId),t.data.Methods.push({Entity:{Id:n.minId,Name:"Return"}}));a()};n.addNoReturn=function(i){i||(i=t.data.Methods.length);n.minId=n.minId%2==0?n.minId-2:n.minId-1;t.wizardItem.MethodIds.push(n.minId);t.data.Methods.push({Entity:{Id:n.minId,Name:"No Return"}});a()}},a=function(){l.initSequenceDiagram(t.wizardItem,n);h.updateSequence(t.data)},d=function(){n.save=function(){var i;if(t.data.Children.Methods)for(i=0;i<t.data.Children.Methods.length;i++){var r=t.data.Children.Methods[i].Entity,u=function(){console.log("saved method")},f=function(){console.log("failed to save method")};t.wizardItem.Id>0?s.updateEntity(r,u,f,"Method"):s.commitEntity(r,u,f,"Method")}n.wizardDone()};t.gotChild=function(i){i.Type=="Method"?t.data.Children.Methods.push(i):h.refreshTree(function(){n.editChild(i)})}},g=function(){var i=0;n.executionUnits=function(){var r,e,u,f,o,s;if(!n.calculatedUnits){if(r=[{id:-1,name:"Not Assigned",isMilestone:!0,counter:i++}],t.unit=r[0],t.data.Milestones){for(e=0;e<t.data.Milestones.length;e++)if(u=t.data.Milestones[e],f={id:u.Id,name:u.Name,isMilestone:!0,counter:i++},t.wizardItem.ContainerID==u.Id&&t.wizardItem.ContainerEntityType=="Milestone"&&(t.unit=f),r.push(f),u.Children)for(o=0;o<u.Children.length;o++)s=u.Children[o],f={id:s.Id,name:s.Name,counter:i++},t.wizardItem.ContainerID==s.Id&&t.wizardItem.ContainerEntityType=="Sprint"&&(t.unit=f),r.push(f);r.length>0&&n.unit==null&&(t.unit=r[0])}n.calculatedUnits=r}return n.calculatedUnits}}}]);
/*
//# sourceMappingURL=entityCtrl.min.js.map
*/